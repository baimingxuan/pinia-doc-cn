<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Plugins | Pinia 中文文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="文档内容详细翻译自官方英文文档">
    
    <link rel="preload" href="/pinia-doc-cn/assets/css/0.styles.7ca0e035.css" as="style"><link rel="preload" href="/pinia-doc-cn/assets/js/app.26e1221b.js" as="script"><link rel="preload" href="/pinia-doc-cn/assets/js/2.cc001fb0.js" as="script"><link rel="preload" href="/pinia-doc-cn/assets/js/18.6ca16828.js" as="script"><link rel="prefetch" href="/pinia-doc-cn/assets/js/10.81b62d2b.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/11.d243ede0.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/12.04ac47d5.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/13.bd9f521e.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/14.b77cfa6e.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/15.ba038539.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/16.46a1f6e6.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/17.59f4af1b.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/19.f941157e.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/20.b0c620ba.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/21.1ff9a2c6.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/22.e7b1edc1.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/23.6735df5c.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/3.32b655d3.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/4.b7d0708f.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/5.9e2f4ca7.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/6.c7b54f12.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/7.c7f5398c.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/8.ff83f9c5.js"><link rel="prefetch" href="/pinia-doc-cn/assets/js/9.eada0501.js">
    <link rel="stylesheet" href="/pinia-doc-cn/assets/css/0.styles.7ca0e035.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/pinia-doc-cn/" class="home-link router-link-active"><!----> <span class="site-name">Pinia 中文文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/baimingxuan/pinia-doc-cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/baimingxuan/pinia-doc-cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/pinia-doc-cn/guide/introduction" class="sidebar-heading clickable"><span>介绍</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/pinia-doc-cn/guide/introduction.html" class="sidebar-link">Pinia是什么？</a></li><li><a href="/pinia-doc-cn/guide/getting-started.html" class="sidebar-link">快速上手</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/pinia-doc-cn/core/defining-store" class="sidebar-heading clickable open"><span>核心概念</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/pinia-doc-cn/core/defining-store.html" class="sidebar-link">定义Store</a></li><li><a href="/pinia-doc-cn/core/state.html" class="sidebar-link">State</a></li><li><a href="/pinia-doc-cn/core/getters.html" class="sidebar-link">Getters</a></li><li><a href="/pinia-doc-cn/core/actions.html" class="sidebar-link">Actions</a></li><li><a href="/pinia-doc-cn/core/plugins.html" aria-current="page" class="active sidebar-link">Plugins</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pinia-doc-cn/core/plugins.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/pinia-doc-cn/core/plugins.html#扩展-store" class="sidebar-link">扩展 Store</a></li><li class="sidebar-sub-header"><a href="/pinia-doc-cn/core/plugins.html#添加新的外部属性" class="sidebar-link">添加新的外部属性</a></li><li class="sidebar-sub-header"><a href="/pinia-doc-cn/core/plugins.html#在插件内部调用-subscribe" class="sidebar-link">在插件内部调用 $subscribe</a></li><li class="sidebar-sub-header"><a href="/pinia-doc-cn/core/plugins.html#添加新选项" class="sidebar-link">添加新选项</a></li><li class="sidebar-sub-header"><a href="/pinia-doc-cn/core/plugins.html#typescript" class="sidebar-link">TypeScript</a></li><li class="sidebar-sub-header"><a href="/pinia-doc-cn/core/plugins.html#nuxt-js" class="sidebar-link">Nuxt.js</a></li></ul></li><li><a href="/pinia-doc-cn/core/outside-component-usage.html" class="sidebar-link">组件外使用Store</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/pinia-doc-cn/ssr/vue-and-vite" class="sidebar-heading clickable"><span>服务端渲染（SSR）</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/pinia-doc-cn/ssr/vue-and-vite.html" class="sidebar-link">Vue和Vite</a></li><li><a href="/pinia-doc-cn/ssr/nuxt.html" class="sidebar-link">Nuxt</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/pinia-doc-cn/cookbook/migration-vuex" class="sidebar-heading clickable"><span>操作手册</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/pinia-doc-cn/cookbook/migration-vuex.html" class="sidebar-link">从Vuex≤4迁移</a></li><li><a href="/pinia-doc-cn/cookbook/hot-module-replacement.html" class="sidebar-link">HMR(热模块更新)</a></li><li><a href="/pinia-doc-cn/cookbook/testing.html" class="sidebar-link">Testing(测试)</a></li><li><a href="/pinia-doc-cn/cookbook/options-api.html" class="sidebar-link">不使用setup()的用法</a></li><li><a href="/pinia-doc-cn/cookbook/composing-stores.html" class="sidebar-link">组合Stores</a></li><li><a href="/pinia-doc-cn/cookbook/migration-v1-v2.html" class="sidebar-link">从0.x(v1)迁移到v2</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="plugins"><a href="#plugins" class="header-anchor">#</a> Plugins</h1> <p>由于低版本的<code>API</code>，<code>Pinia</code>的<code>stores</code>可以完全扩展。下面是一些你可以做的事情:</p> <ul><li>向<code>stores</code>添加新的属性</li> <li>在定义<code>stores</code>时添加新选项</li> <li>向<code>stores</code>添加新方法</li> <li>包装现有的方法</li> <li>更改甚至取消操作</li> <li>实现像本地存储这样的功能</li> <li>只适用于特定的<code>stores</code></li></ul> <p>使用<code>pinia.use()</code>将插件添加到<code>pinia</code>实例中。最简单的例子是通过返回一个对象向所有<code>stores</code> 添加一个静态属性:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createPinia <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span>

<span class="token comment">// add a property named `secret` to every store that is created after this plugin is installed</span>
<span class="token comment">// this could be in a different file</span>
<span class="token keyword">function</span> <span class="token function">SecretPiniaPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">secret</span><span class="token operator">:</span> <span class="token string">'the cake is a lie'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> pinia <span class="token operator">=</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// give the plugin to pinia</span>
pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>SecretPiniaPlugin<span class="token punctuation">)</span>

<span class="token comment">// in another file</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
store<span class="token punctuation">.</span>secret <span class="token comment">// 'the cake is a lie'</span>
</code></pre></div><p>这对于添加全局对象（如<code>router</code>、<code>modal</code>或<code>toast</code>管理器）非常有用。</p> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p><code>Pinia</code>的插件是一个函数，可以选择返回要添加到<code>store</code>中的属性。它有一个可选参数 <code>context</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">myPiniaPlugin</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span>pinia <span class="token comment">// the pinia created with `createPinia()`</span>
  context<span class="token punctuation">.</span>app <span class="token comment">// the current app created with `createApp()` (Vue 3 only)</span>
  context<span class="token punctuation">.</span>store <span class="token comment">// the store the plugin is augmenting</span>
  context<span class="token punctuation">.</span>options <span class="token comment">// the options object defining the store passed to `defineStore()`</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后将此函数传递给<code>pinia</code>的<code>pinia.use()</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code>pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>myPiniaPlugin<span class="token punctuation">)</span>
</code></pre></div><p>插件只应用于<code>stores</code>被创建在<code>pinia</code>传递给应用程序后 ，否则它们不会被应用。</p> <h2 id="扩展-store"><a href="#扩展-store" class="header-anchor">#</a> 扩展 Store</h2> <p>你可以通过在插件中返回一个属性对象来为每个<code>store</code>添加属性:</p> <div class="language-js extra-class"><pre class="language-js"><code>pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">hello</span><span class="token operator">:</span> <span class="token string">'world'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>你也可以直接在<code>store</code>中设置属性，如果可以的话，请返回版本，以便它们可以被<code>devtools</code>自动跟踪：</p> <div class="language-js extra-class"><pre class="language-js"><code>pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> store <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token string">'world'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>插件返回的任何属性都将由<code>devtools</code>自动追踪，因此为了<code>hello</code>在<code>devtools</code>中可见，请确保仅在开发模式中添加<code>store._customProperties</code>属性，如果您想在<code>devtools</code>中调试的话：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// from the example above</span>
pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> store <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token string">'world'</span>
  <span class="token comment">// make sure your bundler handle this. webpack and vite should do it by default</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// add any keys you set on the store</span>
    store<span class="token punctuation">.</span>_customProperties<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>需要注意的是，每个<code>store</code>都会使用<a href="https://v3.vuejs.org/api/basic-reactivity.html#reactive" target="_blank" rel="noopener noreferrer"><code>reactive</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>包装，并且会自动解包它包含的任何<code>Ref</code>(<code>ref()</code>, <code>computed()</code>, ...）等：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> sharedRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'shared'</span><span class="token punctuation">)</span>
pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> store <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// each store has its individual `hello` property</span>
  store<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'secret'</span><span class="token punctuation">)</span>
  <span class="token comment">// it gets automatically unwrapped</span>
  store<span class="token punctuation">.</span>hello <span class="token comment">// 'secret'</span>

  <span class="token comment">// all stores are sharing the value `shared` property</span>
  store<span class="token punctuation">.</span>shared <span class="token operator">=</span> sharedRef
  store<span class="token punctuation">.</span>shared <span class="token comment">// 'shared'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这就是为什么您可以访问所有不带<code>.value</code>计算属性它们是响应式的原因。</p> <h3 id="添加新状态"><a href="#添加新状态" class="header-anchor">#</a> 添加新状态</h3> <p>如果您想在激活过程中添加新的状态属性或属性到<code>store</code>，您必须在两个地方添加它：</p> <ul><li>在<code>store</code>中，您可以通过<code>store.myState</code>访问它</li> <li>在<code>store.$state</code>中，它可以在<code>devtools</code>中使用，并且在<code>SSR</code>期间被序列化。</li></ul> <p>请注意，这允许您共享<code>ref</code>或<code>computed</code>属性：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> globalSecret <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'secret'</span><span class="token punctuation">)</span>
pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> store <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// `secret` is shared among all stores</span>
  store<span class="token punctuation">.</span>$state<span class="token punctuation">.</span>secret <span class="token operator">=</span> globalSecret
  store<span class="token punctuation">.</span>secret <span class="token operator">=</span> globalSecret
  <span class="token comment">// it gets automatically unwrapped</span>
  store<span class="token punctuation">.</span>secret <span class="token comment">// 'secret'</span>

  <span class="token keyword">const</span> hasError <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span>$state<span class="token punctuation">.</span>hasError <span class="token operator">=</span> hasError
  <span class="token comment">// this one must always be set</span>
  store<span class="token punctuation">.</span>hasError <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>$state<span class="token punctuation">,</span> <span class="token string">'hasError'</span><span class="token punctuation">)</span>

  <span class="token comment">// in this case it's better not to return `hasError` since it</span>
  <span class="token comment">// will be displayed in the `state` section in the devtools</span>
  <span class="token comment">// anyway and if we return it, devtools will display it twice.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>请注意，在插件中发生的状态改变或添加（包括调用<code>store.$patch()</code>）发生在<code>store</code>激活之前，因此不会触发任何订阅。</p> <blockquote><p><strong>WARNING</strong>
如果您使用的是<code>Vue 2</code>，<code>Pinia</code>将受到与<code>Vue</code>相同的反应警告。当创建新的状态属性如 <code>secret</code>和<code>hasError</code>时，您需要使用来自<code>@vue/composition-api</code>的<code>set</code>方法。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> set <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/composition-api'</span>
pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> store <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>store<span class="token punctuation">.</span>$state<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> secretRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'secret'</span><span class="token punctuation">)</span>
    <span class="token comment">// If the data is meant to be used during SSR, you should</span>
    <span class="token comment">// set it on the `$state` property so it is serialized and</span>
    <span class="token comment">// picked up during hydration</span>
    <span class="token function">set</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>$state<span class="token punctuation">,</span> <span class="token string">'secret'</span><span class="token punctuation">,</span> secretRef<span class="token punctuation">)</span>
    <span class="token comment">// set it directly on the store too so you can access it</span>
    <span class="token comment">// both ways: `store.$state.secret` / `store.secret`</span>
    <span class="token function">set</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token string">'secret'</span><span class="token punctuation">,</span> secretRef<span class="token punctuation">)</span>
    store<span class="token punctuation">.</span>secret <span class="token comment">// 'secret'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="添加新的外部属性"><a href="#添加新的外部属性" class="header-anchor">#</a> 添加新的外部属性</h2> <p>当添加外部属性，来自其他库的类实例或简单的非响应式对象时，应该在将对象传递给<code>pinia</code> 之前使用<code>markRaw()</code>包装该对象。下面是一个将路由添加到所有<code>store</code>的示例:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> markRaw <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token comment">// adapt this based on where your router is</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./router'</span>

pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> store <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span>router <span class="token operator">=</span> <span class="token function">markRaw</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="在插件内部调用-subscribe"><a href="#在插件内部调用-subscribe" class="header-anchor">#</a> 在插件内部调用 $subscribe</h2> <p>您也可以在插件中使用<a href="https://baimingxuan.net/pinia-doc-cn/core/state.html#%E8%AE%A2%E9%98%85-state" target="_blank" rel="noopener noreferrer">store.$subscribe<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://baimingxuan.net/pinia-doc-cn/core/actions.html#%E8%AE%A2%E9%98%85-actions" target="_blank" rel="noopener noreferrer">store.$onAction<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> store <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">$subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// react to store changes</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span><span class="token function">$onAction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// react to store actions</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="添加新选项"><a href="#添加新选项" class="header-anchor">#</a> 添加新选项</h2> <p>可以在定义<code>stores</code>时创建新的选项，以便随后从插件中使用它们。例如，你可以创建一个<code>debounce</code>选项，允许你对任何操作进行<code>debounce</code> :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">searchContacts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// this will be read by a plugin later on</span>
  <span class="token literal-property property">debounce</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// debounce the action searchContacts by 300ms</span>
    <span class="token literal-property property">searchContacts</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>插件可以读取该选项来包装<code>actions</code>并替换原来的<code>actions</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// use any debounce library</span>
<span class="token keyword">import</span> debounce <span class="token keyword">from</span> <span class="token string">'lodash/debunce'</span>

pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> options<span class="token punctuation">,</span> store <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>debounce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// we are overriding the actions with new ones</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>debounce<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">debouncedActions<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      debouncedActions<span class="token punctuation">[</span>action<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span>
        store<span class="token punctuation">[</span>action<span class="token punctuation">]</span><span class="token punctuation">,</span>
        options<span class="token punctuation">.</span>debounce<span class="token punctuation">[</span>action<span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">return</span> debouncedActions
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>请注意，使用<code>setup</code>语法时，自定义选项作为第三个参数传入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">defineStore</span><span class="token punctuation">(</span>
  <span class="token string">'search'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// this will be read by a plugin later on</span>
    <span class="token literal-property property">debounce</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// debounce the action searchContacts by 300ms</span>
      <span class="token literal-property property">searchContacts</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="typescript"><a href="#typescript" class="header-anchor">#</a> TypeScript</h2> <p>上面显示的所有内容都可以通过编写支持，因此您无需使用<code>any</code>或<code>@ts-ignore</code>。</p> <h3 id="编写插件"><a href="#编写插件" class="header-anchor">#</a> 编写插件</h3> <p><code>Pinia</code>插件可以按如下方式编写：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> PiniaPluginContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">myPiniaPlugin</span><span class="token punctuation">(</span>context<span class="token operator">:</span> PiniaPluginContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="编写新的store属性"><a href="#编写新的store属性" class="header-anchor">#</a> 编写新的store属性</h3> <p>当向<code>stores</code>添加新属性时，您还应该扩展<code>PiniaCustomProperties</code>接口。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token string">'pinia'</span>

<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'pinia'</span> <span class="token punctuation">{</span>
  <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PiniaCustomProperties</span> <span class="token punctuation">{</span>
    <span class="token comment">// by using a setter we can allow both strings and refs</span>
    <span class="token keyword">set</span> <span class="token function">hello</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> Ref<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token keyword">get</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span>

    <span class="token comment">// you can define simpler values too</span>
    simpleNumber<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后可以安全地写入和读取：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> store <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token string">'Hola'</span>
  store<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'Hola'</span><span class="token punctuation">)</span>

  store<span class="token punctuation">.</span><span class="token builtin">number</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// @ts-expect-error: we haven't typed this correctly</span>
  store<span class="token punctuation">.</span><span class="token builtin">number</span> <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>PiniaCustomProperties</code>是一个泛型类型，允许您引用<code>store</code>的属性。想象一下下面的示例，我们将初始选项复制为<code>$options</code>（这仅适用于<code>option stores</code>）：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> options <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> $options<span class="token operator">:</span> options <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>我们可以通过使用<code>PiniaCustomProperties</code>的4个泛型类型来正确地输入这个值:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token string">'pinia'</span>

<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'pinia'</span> <span class="token punctuation">{</span>
  <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PiniaCustomProperties<span class="token operator">&lt;</span>Id<span class="token punctuation">,</span> <span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    $options<span class="token operator">:</span> <span class="token punctuation">{</span>
      id<span class="token operator">:</span> Id
      state<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span>
      getters<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">G</span>
      actions<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">A</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>TIP</p> <p>在泛型中扩展类型时，它们的命名必须与源码中的完全相同。<code>Id</code>不能命名为<code>id</code>或<code>I</code>，<code>S</code>也不能命名为<code>State</code>。以下是每个字母所代表的含义：</p> <ul><li>S: State</li> <li>G: Getters</li> <li>A: Actions</li> <li>SS: Setup Store / Store</li></ul></blockquote> <h3 id="编写新的状态"><a href="#编写新的状态" class="header-anchor">#</a> 编写新的状态</h3> <p>当添加新的状态属性时(同时添加到<code>store</code>和<code>store.$state</code>)，您需要将类型添加到<code>PiniaCustomStateProperties</code>。与<code>PiniaCustomProperties</code>不同的是，它只接收<code>State</code>泛型：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token string">'pinia'</span>

<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'pinia'</span> <span class="token punctuation">{</span>
  <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PiniaCustomStateProperties<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    hello<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="编写新的创建选项"><a href="#编写新的创建选项" class="header-anchor">#</a> 编写新的创建选项</h3> <p>当为<code>defineStore()</code>创建新选项时，您应该扩展<code>DefineStoreOptionsBase</code>。与<code>PiniaCustomProperties</code>不同的是，它只公开两种泛型：<code>State</code>和<code>Store</code>类型，允许您限制可以定义的类型。例如，你可以使用<code>actions</code>的名称:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token string">'pinia'</span>

<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'pinia'</span> <span class="token punctuation">{</span>
  <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">DefineStoreOptionsBase<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> Store<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// allow defining a number of ms for any of the actions</span>
    debounce<span class="token operator">?</span><span class="token operator">:</span> Partial<span class="token operator">&lt;</span>Record<span class="token operator">&lt;</span><span class="token keyword">keyof</span> StoreActions<span class="token operator">&lt;</span>Store<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">&gt;&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>TIP
还有一个<code>StoreGetters</code>类型用于从<code>Store</code>类型中提取<code>getters</code>。您还可以分别通过<code>DefineStoreOptions</code>和<code>DefineSetupStoreOptions</code>类型来扩展设置<code>setup stores</code>或<code>option stores</code>的选项。</p></blockquote> <h2 id="nuxt-js"><a href="#nuxt-js" class="header-anchor">#</a> Nuxt.js</h2> <p>当<code>Nuxt</code>和<code>Pinia</code>一起使用时，您必须先创建一个<a href="https://nuxtjs.org/docs/2.x/directory-structure/plugins" target="_blank" rel="noopener noreferrer"><code>Nuxt</code>插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这将使您可以访问该<code>Pinia</code>实例：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// plugins/myPiniaPlugin.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PiniaPluginContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nuxt/types'</span>

<span class="token keyword">function</span> <span class="token function">MyPiniaPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> store <span class="token punctuation">}</span><span class="token operator">:</span> PiniaPluginContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">$subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mutation<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// react to store changes</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[🍍 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mutation<span class="token punctuation">.</span>storeId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mutation<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> creationTime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> myPlugin<span class="token operator">:</span> Plugin <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> pinia <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>MyPiniaPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> myPlugin
</code></pre></div><p>注意上面的例子使用的是<code>TypeScript</code>，如果你使用的是<code>.js</code>文件，你必须删除<code>PiniaPluginContext</code>的类型注释和<code>Plugin</code>的引入。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/baimingxuan/pinia-doc-cn/edit/main/docs/core/plugins.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">2022/3/24 下午10:47:41</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pinia-doc-cn/core/actions.html" class="prev">
        Actions
      </a></span> <span class="next"><a href="/pinia-doc-cn/core/outside-component-usage.html">
        组件外使用Store
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/pinia-doc-cn/assets/js/app.26e1221b.js" defer></script><script src="/pinia-doc-cn/assets/js/2.cc001fb0.js" defer></script><script src="/pinia-doc-cn/assets/js/18.6ca16828.js" defer></script>
  </body>
</html>
